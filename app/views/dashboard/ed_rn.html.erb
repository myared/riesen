<div class="dashboard-sidebar">
  <div class="sidebar-stats">
    <div class="stat-card">
      <div class="stat-label">ED Patients</div>
      <div class="stat-value"><%= @patients.count %></div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Avg Treatment Time</div>
      <div class="stat-value"><%= @avg_wait_time.round %>m</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">Beds Available</div>
      <div class="stat-value">8/20</div>
    </div>
  </div>
</div>

<div class="dashboard-main">
  <h2>ED RN Patients</h2>

  <% if @patients.empty? %>
    <div class="empty-state">
      <p>No patients currently assigned to ED RN</p>
    </div>
  <% else %>
    <div class="patient-table">
      <table>
        <thead>
          <tr>
            <th>Patient</th>
            <th>Care Pathway</th>
            <th>ESI</th>
            <th>Wait / Progress</th>
            <th>Chief Complaint</th>
            <th>Provider</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @patients.each do |patient| %>
            <tr data-patient-id="<%= patient.id %>">
              <td>
                <%= link_to patient_path(patient), data: { turbo_frame: "patient_modal" } do %>
                  <div><strong><%= patient.full_name %></strong></div>
                  <div style="font-size: 12px; color: #586069;"><%= patient.age %>Y â€¢ MRN: <%= patient.mrn %></div>
                <% end %>
              </td>
              <td>
                <div class="care-pathway-cell">
                  <% progress = patient.active_care_pathway&.progress_percentage || 0 %>
                  <%= link_to patient_care_pathways_path(patient, referrer: 'ed_rn'),
                              class: "progress-ring-button",
                              style: "--progress: #{progress}" do %>
                    <span class="progress-text"><%= progress %>%</span>
                  <% end %>
                </div>
              </td>
              <td>
                <span class="esi-badge esi-<%= patient.esi_level %>">
                  ESI <%= patient.esi_level %>
                </span>
              </td>
              <td>
                <% if patient.location_needs_room_assignment? %>
                  <div class="wait-progress <%= patient.room_assignment_status_class %>"
                       data-controller="timer"
                       data-timer-start-time-value="<%= patient.room_assignment_started_at&.iso8601 %>"
                       data-timer-target-minutes-value="<%= Patient::ROOM_ASSIGNMENT_TARGET %>"
                       data-timer-thresholds-value='<%= { target: Patient::ROOM_ASSIGNMENT_TARGET }.to_json %>'>
                    <span class="wait-time" data-timer-target="display"><%= patient.time_waiting_for_room %>m</span>
                    <div class="progress-bar">
                      <div class="progress-bar-fill"
                           data-timer-target="progress"
                           style="width: <%= [(patient.time_waiting_for_room.to_f / Patient::ROOM_ASSIGNMENT_TARGET * 100), 100].min %>%"></div>
                    </div>
                    <span class="wait-target" data-timer-target="label">ROOM ASSIGNMENT TIMER</span>
                  </div>
                <% else %>
                  <%
                    # Get the backend calculated wait time and timer details
                    backend_wait_time = patient.wait_time_minutes
                    longest_timer = patient.longest_wait_timer

                    # Determine the appropriate start time based on the backend logic
                    start_time = if backend_wait_time > 0 && longest_timer
                      case longest_timer[:type]
                      when :arrival
                        patient.arrival_time
                      when :room_assignment
                        patient.triage_completed_at
                      when :order
                        if longest_timer[:order]
                          case longest_timer[:order].status.to_sym
                          when :ordered
                            longest_timer[:order].ordered_at
                          when :collected
                            longest_timer[:order].collected_at
                          when :in_lab
                            longest_timer[:order].in_lab_at
                          when :exam_started
                            longest_timer[:order].exam_started_at
                          else
                            longest_timer[:order].status_updated_at || longest_timer[:order].ordered_at
                          end
                        else
                          nil
                        end
                      else
                        nil
                      end
                    else
                      nil
                    end
                  %>

                  <% if backend_wait_time == 0 %>
                    <div class="wait-progress">
                      <span class="wait-time no-tasks">No tasks pending</span>
                    </div>
                  <% else %>
                    <div class="wait-progress <%= patient.wait_status_class %>"
                         data-controller="timer"
                         <% if start_time %>
                           data-timer-start-time-value="<%= start_time&.iso8601 %>"
                         <% end %>
                         data-timer-target-minutes-value="<%= patient.esi_target_minutes %>"
                         data-timer-thresholds-value='<%= { useTarget: true }.to_json %>'>
                      <span class="wait-time" data-timer-target="display"><%= backend_wait_time %>m</span>
                      <div class="progress-bar">
                        <div class="progress-bar-fill"
                             data-timer-target="progress"
                             style="width: <%= [patient.wait_progress_percentage, 100].min %>%"></div>
                      </div>
                      <span class="wait-target" data-timer-target="label"><%= patient.esi_target_label %></span>
                    </div>
                  <% end %>
                <% end %>
              </td>
              <td><%= patient.chief_complaint %></td>
              <td><%= patient.provider || 'Not Assigned' %></td>
              <td>
                <div class="action-buttons">
                  <%= patient_action_button(patient, 'ed_rn') %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>

<turbo-frame id="patient_modal"></turbo-frame>
