<%= turbo_frame_tag "patient_modal" do %>
<div class="modal-overlay" data-return-path="<%= @return_path %>"></div>
<div class="patient-detail-modal">
  <div class="modal-header">
    <div class="patient-header-info">
      <h2 class="patient-name"><%= @patient.full_name %></h2>
      <div class="patient-meta">
        <span><%= @patient.age %>yo <%= @patient.age < 18 ? 'Pediatric' : 'Adult' %></span>
        <span>‚Ä¢ MRN: <%= @patient.mrn %></span>
        <span>‚Ä¢ Encounter: ENC-<%= @patient.mrn %>-2025</span>
      </div>
      <div class="patient-location">
        <span>Location: <%= @patient.location || 'Waiting Room' %></span>
        <span>‚Ä¢ Provider: <%= @patient.provider || 'Not Assigned' %></span>
      </div>
    </div>
    <div class="patient-badges">
      <% if @patient.intake_complete? %>
        <span class="esi-badge esi-<%= @patient.esi_level %>">ESI-<%= @patient.esi_level %></span>
      <% else %>
        <span class="esi-badge" style="opacity: 0.5;">ESI Pending</span>
      <% end %>
    </div>
    <%= link_to "√ó", @return_path, class: "modal-close", "data-turbo": false %>
  </div>
  
  <div class="modal-tabs">
    <button class="tab-button active" data-tab="overview">Overview</button>
    <button class="tab-button" data-tab="patient-log">Patient Log</button>
    <button class="tab-button" data-tab="demo-orders">‚≠ê</button>
  </div>
  
  <div class="modal-content">
    <div class="tab-content active" id="overview">
      <div class="overview-grid">
        <div class="overview-card">
          <h3>‚è∞ Visit Information</h3>
          <div class="info-grid">
            <div class="info-item">
              <label>Arrival:</label>
              <span><%= @patient.arrival_time&.in_time_zone&.strftime("%l:%M:%S %p PST") || "09:30:48 AM PST" %></span>
            </div>
            <div class="info-item">
              <label>Wait Time:</label>
              <span><%= @patient.wait_time_minutes || 12 %>m</span>
            </div>
            <div class="info-item">
              <label>Pain Score:</label>
              <span><%= @patient.pain_score || 8 %>/10</span>
            </div>
            <div class="info-item full-width">
              <label>Chief Complaint:</label>
              <span><%= @patient.chief_complaint || "Wrist pain after skateboard fall, knee laceration" %></span>
            </div>
          </div>
        </div>
        
        <div class="overview-card">
          <h3>ü©∫ Vitals Snapshot</h3>
          <div class="vitals-grid">
            <% if @vitals %>
              <div class="vital-item">
                <label>Heart Rate</label>
                <div class="vital-value"><%= @vitals.heart_rate %> bpm</div>
              </div>
              <div class="vital-item">
                <label>Blood Pressure</label>
                <div class="vital-value"><%= @vitals.blood_pressure %></div>
              </div>
              <div class="vital-item">
                <label>Respiratory Rate</label>
                <div class="vital-value"><%= @vitals.respiratory_rate %> /min</div>
              </div>
              <div class="vital-item">
                <label>Temperature</label>
                <div class="vital-value"><%= @vitals.temperature %>¬∞C (<%= @vitals.temperature_fahrenheit %>¬∞F)</div>
              </div>
              <div class="vital-item">
                <label>SpO2</label>
                <div class="vital-value"><%= @vitals.spo2 %>%</div>
              </div>
              <div class="vital-item">
                <label>Weight</label>
                <div class="vital-value"><%= @vitals.weight %> kg</div>
              </div>
            <% else %>
              <div class="vital-item">
                <label>Heart Rate</label>
                <div class="vital-value">95 bpm</div>
              </div>
              <div class="vital-item">
                <label>Blood Pressure</label>
                <div class="vital-value">120/90</div>
              </div>
              <div class="vital-item">
                <label>Respiratory Rate</label>
                <div class="vital-value">18 /min</div>
              </div>
              <div class="vital-item">
                <label>Temperature</label>
                <div class="vital-value">37.1¬∞C (98.8¬∞F)</div>
              </div>
              <div class="vital-item">
                <label>SpO2</label>
                <div class="vital-value">99%</div>
              </div>
              <div class="vital-item">
                <label>Weight</label>
                <div class="vital-value">68 kg</div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="patient-log">
      <div class="event-log">
        <h3>üìã Patient Event Log</h3>
        <table class="events-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Category</th>
              <th>Action</th>
              <th>Details</th>
              <th>Performed By</th>
            </tr>
          </thead>
          <tbody>
            <% if @events.any? %>
              <% @events.each do |event| %>
                <tr>
                  <td><%= event.time.in_time_zone.strftime("%l:%M:%S %p PST") %></td>
                  <td><span class="category-badge <%= event.category&.downcase %>"><%= event.category || 'triage' %></span></td>
                  <td><%= event.action %></td>
                  <td><%= event.details %></td>
                  <td>
                    <span class="performer-icon">üë§</span>
                    <%= event.performed_by %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td>09:30:48 AM PST</td>
                <td><span class="category-badge triage">triage</span></td>
                <td>Patient arrived</td>
                <td>Chief complaint: Wrist pain after skateboard fall, knee laceration</td>
                <td>
                  <span class="performer-icon">üë§</span>
                  Registration
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-content" id="demo-orders">
      <div class="demo-orders-container">
        <h3>Demo Orders</h3>
        <p style="margin-bottom: 20px; color: #666;">Add all standard orders with one click for demo purposes.</p>

        <%= button_to "Add all orders",
            add_demo_orders_patient_path(@patient),
            method: :post,
            class: "btn btn-primary",
            style: "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: transform 0.2s;",
            onmouseover: "this.style.transform='scale(1.05)'",
            onmouseout: "this.style.transform='scale(1)'",
            data: { turbo: false } %>

        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h4 style="margin-bottom: 15px;">Orders that will be added:</h4>

          <div style="margin-bottom: 20px;">
            <h5 style="color: #e91e63; margin-bottom: 10px;">üíä Medications</h5>
            <ul style="list-style: none; padding-left: 0;">
              <li>‚Ä¢ Morphine 2mg IV</li>
              <li>‚Ä¢ Reglan</li>
              <li>‚Ä¢ Zofran 4mg IV</li>
            </ul>
          </div>

          <div style="margin-bottom: 20px;">
            <h5 style="color: #4caf50; margin-bottom: 10px;">üì∑ Imaging</h5>
            <ul style="list-style: none; padding-left: 0;">
              <li>‚Ä¢ X-Ray Knee</li>
              <li>‚Ä¢ CT Abdomen/Pelvis with Contrast</li>
            </ul>
          </div>

          <div>
            <h5 style="color: #2196f3; margin-bottom: 10px;">üî¨ Labs</h5>
            <ul style="list-style: none; padding-left: 0;">
              <li>‚Ä¢ CBC with Differential</li>
              <li>‚Ä¢ Comprehensive Metabolic Panel</li>
              <li>‚Ä¢ Urinalysis</li>
              <li>‚Ä¢ Troponin</li>
              <li>‚Ä¢ Urine Culture</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetTab = this.getAttribute('data-tab');
      
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      this.classList.add('active');
      document.getElementById(targetTab).classList.add('active');
    });
  });
  
  // Handle clicking outside modal to close
  const overlay = document.querySelector('.modal-overlay');
  if (overlay) {
    overlay.addEventListener('click', function() {
      const returnPath = this.getAttribute('data-return-path');
      if (returnPath) {
        window.location.href = returnPath;
      }
    });
  }
})();
</script>
<% end %>