<!-- Add Order Modal -->
<div id="addOrderModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Order</h3>
      <button class="modal-close" onclick="closeAddOrderModal()">&times;</button>
    </div>
    
    <%= form_with url: add_order_patient_care_pathway_path(@patient, @care_pathway),
                  method: :post,
                  data: { turbo: true },
                  id: "add-order-form" do |f| %>
      <div class="modal-body">
        <div class="form-group">
          <label for="order_type">Order Type</label>
          <select name="order[order_type]" id="order_type" class="form-control" onchange="updateOrderOptions()" required>
            <option value="">Select Type...</option>
            <option value="lab">Lab</option>
            <option value="medication">Medication</option>
            <option value="imaging">Imaging</option>
          </select>
        </div>

        <div class="form-group">
          <label for="order_name">Order Name</label>
          <select name="order[name]" id="order_name" class="form-control" disabled required>
            <option value="">First select order type...</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeAddOrderModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" onclick="return validateOrderForm()">Add Order</button>
      </div>
    <% end %>
  </div>
</div>

<script>
  const labOrders = <%= CarePathwayOrder::LAB_ORDERS.to_json.html_safe %>;
  const medications = <%= CarePathwayOrder::MEDICATIONS.to_json.html_safe %>;
  const imagingOrders = <%= CarePathwayOrder::IMAGING_ORDERS.to_json.html_safe %>;
  
  function showAddOrderModal(patientId, pathwayId) {
    document.getElementById('addOrderModal').style.display = 'flex';
  }
  
  function closeAddOrderModal() {
    document.getElementById('addOrderModal').style.display = 'none';
    // Reset form
    document.getElementById('add-order-form').reset();
    document.getElementById('order_name').disabled = true;
    document.getElementById('order_name').innerHTML = '<option value="">First select order type...</option>';
  }
  
  function updateOrderOptions() {
    const orderType = document.getElementById('order_type').value;
    const orderNameSelect = document.getElementById('order_name');

    orderNameSelect.innerHTML = '';

    if (orderType === '') {
      orderNameSelect.innerHTML = '<option value="">First select order type...</option>';
      orderNameSelect.disabled = true;
      return;
    }

    orderNameSelect.disabled = false;
    orderNameSelect.innerHTML = '<option value="">Select order...</option>';

    let options = [];
    switch(orderType) {
      case 'lab':
        options = labOrders;
        break;
      case 'medication':
        options = medications;
        break;
      case 'imaging':
        options = imagingOrders;
        break;
    }

    options.forEach(option => {
      const optionElement = document.createElement('option');
      optionElement.value = option;
      optionElement.textContent = option;
      orderNameSelect.appendChild(optionElement);
    });
  }

  function validateOrderForm() {
    const orderType = document.getElementById('order_type').value;
    const orderName = document.getElementById('order_name').value;

    if (!orderType) {
      alert('Please select an Order Type');
      return false;
    }

    if (!orderName) {
      alert('Please select an Order Name');
      return false;
    }

    return true;
  }
  
  // Handle form submission with Turbo
  document.addEventListener('turbo:submit-end', (event) => {
    if (event.target.id === 'add-order-form') {
      if (event.detail.success) {
        closeAddOrderModal();
        // Form was successful, page will be updated by redirect
      }
    }
  });
</script>
